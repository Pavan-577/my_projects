<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIML Chatbot</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>

<div class="app">

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar">
    <button class="new-chat-btn" onclick="newChat()">+ New Chat</button>
    <div id="chatHistory" class="chat-history">
      <div class="chat-item active">New Chat</div>
    </div>
  </aside>

  <!-- RIGHT CHAT AREA -->
  <main class="chat-area">

    <header class="chat-header">ü§ñ AIML Chatbot</header>

    <div id="chat-box">
      <div class="bot">Hi üëã Ask me anything.</div>
    </div>

    <div id="typing" class="typing">AI is typing...</div>

    <!-- INPUT AREA -->
    <div class="input-area">
      <input id="msg" placeholder="Ask something..." autocomplete="off">
      <button class="mic-btn" onclick="startVoice()">üé§</button>
      
      <button class="stop-btn" onclick="stopAllAudio()">‚èπ</button>
      <button onclick="sendMessage()">‚û§</button>
    </div>

  </main>

</div>

<script>
let recognition = null;
let femaleVoice = null;

const inputBox = document.getElementById("msg");
const chatBox = document.getElementById("chat-box");
const typing = document.getElementById("typing");

/* ---------------- INIT FEMALE VOICE ---------------- */
function loadFemaleVoice() {
  const voices = window.speechSynthesis.getVoices();

  femaleVoice = voices.find(v =>
    v.name.toLowerCase().includes("female") ||
    v.name.toLowerCase().includes("zira") ||       // Windows female
    v.name.toLowerCase().includes("samantha") ||  // macOS female
    v.name.toLowerCase().includes("google")       // Chrome female
  );

  if (!femaleVoice && voices.length > 0) {
    femaleVoice = voices[0]; // fallback
  }
}

/* Needed because voices load async */
window.speechSynthesis.onvoiceschanged = loadFemaleVoice;

/* ---------------- SEND MESSAGE ---------------- */
function sendMessage() {
  const msg = inputBox.value.trim();
  if (!msg) return;

  stopAllAudio(); // üî• stop any running audio first

  addMessage(msg, "user");
  inputBox.value = "";
  typing.style.display = "block";

  fetch("/chat", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ message: msg })
  })
  .then(res => res.json())
  .then(data => {
    typing.style.display = "none";
    addMessage(data.reply, "bot");
    speakFemale(data.reply);
  })
  .catch(() => {
    typing.style.display = "none";
    addMessage("‚ö†Ô∏è AI not responding", "bot");
  });
}

/* ---------------- ENTER KEY ---------------- */
inputBox.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

/* ---------------- ADD MESSAGE ---------------- */
function addMessage(text, cls) {
  const div = document.createElement("div");
  div.className = cls;
  div.innerText = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ---------------- NEW CHAT ---------------- */
function newChat() {
  stopAllAudio();
  chatBox.innerHTML = `<div class="bot">ü§ñ New chat started. Ask me anything.</div>`;
}

/* ---------------- üé§ START MIC ---------------- */
function startVoice() {
  stopAllAudio(); // üî• ensure clean start

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("Voice input not supported. Use Chrome or Edge.");
    return;
  }

  recognition = new SR();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.start();

  recognition.onresult = e => {
    inputBox.value = e.results[0][0].transcript;
    sendMessage();
  };

  recognition.onerror = e => {
    console.error("Mic error:", e.error);
  };
}

/* ---------------- ‚èπ STOP EVERYTHING ---------------- */
function stopAllAudio() {
  // Stop mic
  if (recognition) {
    recognition.stop();
    recognition = null;
  }

  // Stop bot voice
  if (window.speechSynthesis.speaking) {
    window.speechSynthesis.cancel();
  }
}

/* ---------------- üîä FEMALE VOICE ---------------- */
function speakFemale(text) {
  if (!window.speechSynthesis) return;

  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = femaleVoice;
  utter.rate = 1;
  utter.pitch = 1.2;

  window.speechSynthesis.speak(utter);
}
</script>
